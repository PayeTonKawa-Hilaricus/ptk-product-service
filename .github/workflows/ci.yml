name: üõ°Ô∏è CI/CD Pipeline - Quality & Security

on:
  push:
    branches: ['main', 'develop']
  pull_request:
    branches: ['main', 'develop']

jobs:
  # ===========================================================================
  # JOB 1: QUALITY CONTROL & SECURITY BASICS
  # Linting, Formatting, Dependency Audit, Secret Detection
  # ===========================================================================
  quality-check:
    name: üîç Quality & Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important pour Gitleaks (scan historique)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # 1. Formatage (Prettier)
      - name: üé® Check Formatting
        run: npx prettier --check .

      # 2. Linting Strict (ESLint)
      - name: üßπ Linting Strict
        run: npm run lint

      # 3. Audit des d√©pendances (Vuln√©rabilit√©s connues)
      - name: üïµÔ∏è Dependency Audit
        run: npm audit --audit-level=high
        continue-on-error: true # On alerte mais on ne bloque pas forc√©ment tout de suite

      # 4. D√©tection de Secrets (Remplacement : TruffleHog au lieu de Gitleaks)
      - name: üê∑ TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # ===========================================================================
  # JOB 2: TESTING (UNIT, INTEGRATION, CONTRACT)
  # N√©cessite une base de donn√©es temporaire pour les tests d'int√©gration
  # ===========================================================================
  testing:
    name: üß™ Test Suite
    runs-on: ubuntu-latest
    needs: quality-check # On ne teste que si la qualit√© est OK

    # Service Container : On lance un Postgres pour les tests E2E
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        # Healthcheck pour attendre que la DB soit pr√™te
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # 1. Tests Unitaires
      - name: üß© Unit Tests
        run: npm run test -- --coverage

      # 2. Tests d'Int√©gration (E2E)
      # On injecte les variables d'env pour se connecter au Service Postgres ci-dessus
      - name: üîó Integration Tests (E2E)
        run: npm run test:e2e
        env:
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USER: test_user
          DATABASE_PASSWORD: test_password
          DATABASE_NAME: test_db

      # 3. Contract Testing (Pact)
      # Note: Ne s'ex√©cute que si le script existe dans package.json
      - name: ü§ù Contract Testing (Pact)
        run: |
          if npm run | grep -q "test:pact"; then
            npm run test:pact
          else
            echo "‚ö†Ô∏è Pas de script 'test:pact' d√©tect√©, √©tape ignor√©e."
          fi

  # ===========================================================================
  # JOB 3: ADVANCED SECURITY (SAST)
  # Analyse statique du code pour trouver des failles de s√©curit√© logiques
  # ===========================================================================
  sast-analysis:
    name: üõ°Ô∏è SAST (CodeQL)
    runs-on: ubuntu-latest
    needs: quality-check
    permissions:
      security-events: write # Obligatoire pour uploader les rapports
      actions: read
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript # NestJS = Typescript/Javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ===========================================================================
  # JOB 4: DELIVERY (BUILD DOCKER)
  # V√©rifie que l'image Docker se construit bien (sans la pousser pour l'instant)
  # ===========================================================================
  docker-build:
    name: üê≥ Docker Build Check
    runs-on: ubuntu-latest
    needs: [testing, sast-analysis] # On ne build que si tout est vert

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false # On ne push pas sur le Hub pour l'instant, on v√©rifie juste le build
          tags: payetonkawa/service:latest
